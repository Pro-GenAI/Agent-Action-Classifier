version: "3.8"

services:
  mcp_server:
    build: .
    container_name: mcp_server
    command: python agent_action_guard/scripts/sample_mcp_server.py
    ports:
      - "8080:8080"

  proxy_guard:
    build: .
    container_name: proxy_guard
    env_file:
      - .env
    command: sh -c "mcp-proxy-guarded --proxy-to http://mcp_server:8080/mcp --port 8081"
    ports:
      - "8081:8081"
    depends_on:
      - mcp_server

  api_server:
    build: .
    container_name: api_server
    env_file:
      - .env
    command: python agent_action_guard/scripts/api_server.py
    ports:
      - "8000:8000"
    depends_on:
      - proxy_guard

  chat_server:
    build: .
    container_name: chat_server
    environment:
      - BACKEND_BASE_URL=${BACKEND_BASE_URL}
      - BACKEND_API_KEY=${BACKEND_API_KEY}
    command: python agent_action_guard/scripts/chat_server.py
    ports:
      - "7860:7860"
    depends_on:
      - api_server

  ngrok:
    image: wernight/ngrok
    container_name: ngrok
    environment:
      - NGROK_AUTHTOKEN=${NGROK_AUTHTOKEN}
      - NGROK_DOMAIN=${NGROK_DOMAIN}
    command: http ---url="${NGROK_DOMAIN}" --log=stdout 8081
    ports:
      - "4040:4040"
    depends_on:
      - proxy_guard

networks:
  default:
    driver: bridge
